{% extends 'base.html.j2' %}

{% block title %}{{ title }}{% endblock %}

{% block body %}
    <div class="container grid-lg py-2">
        <h2>{{ title }}</h2>

        {% if version %}
            <p>Version: {{ version }}</p>
        {% endif %}

        {% include 'navigation_bar.html.j2' %}

        <form id="checklist_form" method="post" onsubmit="window.removeEventListener('beforeunload', handleBeforeUnload);">
            {% block form_content %}
            {% endblock %}
        </form>

        <p class="d-flex" aria-hidden="true">
            <i class="fa-solid clf-fa-required text-error"></i> <i>Required field(s)</i>
        </p>

        {% include 'navigation_bar.html.j2' %}
    </div>

    <script>
        async function checkHeartBeat(url, server_id) {
            try {
                const request = new Request(
                    url + '/heartbeat',
                    {
                        method: 'GET',
                        headers: {'Accept': 'application/json'},
                        mode: 'same-origin',
                    },
                );

                const response = await fetch(request);

                if (!response.ok) {
                    return false;
                }

                const data = response.json()

                return data.server_id === server_id;
            } catch (error) {
                return false;
            }
        }

        function saveFormValues(form) {
            Array.from(form).forEach(element => {
                if (['INPUT', 'SELECT', 'TEXTAREA'].includes(element.tagName)) {
                    element.dataset.clfValue = element.value;
                }
            });
        }

        function formChanged(form) {
            return Array.from(form).some((element) => {
                return ['INPUT', 'SELECT', 'TEXTAREA'].includes(element.tagName) &&
                    'clfValue' in element.dataset &&
                    element.dataset.clfValue !== element.value;
            });
        }

        function handleBeforeUnload(event) {
            if (formChanged(form)) {
                event.preventDefault();
            }
        }

        const form = document.getElementById('checklist_form');
        const server_id = '{{ server_id }}';

        window.addEventListener('DOMContentLoaded', () => {
            saveFormValues(form);
        });

        window.addEventListener('beforeunload', handleBeforeUnload);

        const heartbeatInterval = setInterval(
            () => {
                checkHeartBeat(window.location.origin).then(
                    (server_alive) => {
                        if (!server_alive) {
                            const warning_toast = document.createElement('div');
                            warning_toast.classList.add('my-2', 'toast', 'toast-error');
                            warning_toast.textContent = 'The server has shut down. Some of your changes might not have been saved.';

                            form.parentNode.prepend(warning_toast);
                            clearInterval(heartbeatInterval);
                        }
                    }
                );
            },
            1000,
        )
    </script>
{% endblock %}